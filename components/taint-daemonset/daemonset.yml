apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: gpu-worker-taint
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: gpu-worker-taint
  template:
    metadata:
      labels:
        app: gpu-worker-taint
    spec:
      serviceAccountName: node-taint-sa
      tolerations:
        - key: "gpu"
          operator: "Equal"
          value: "worker"
          effect: "NoSchedule"
      containers:
        - name: taint
          image: alpine:3.20
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache curl

              curl -sSL -o /usr/local/bin/kubectl \
                https://storage.googleapis.com/kubernetes-release/release/v1.30.0/bin/linux/amd64/kubectl
              chmod +x /usr/local/bin/kubectl

              if echo "$NODE_NAME" | grep -q "gpu-worker"; then
                echo "Tainting and labelling node $NODE_NAME"
                kubectl taint node "$NODE_NAME" nvidia.com/gpu=worker:NoSchedule --overwrite
                kubectl label node "$NODE_NAME" node-type=gpu-worker
                kubectl label node "$NODE_NAME" nvidia.com/mig.config=all-7g.40gb

                echo "Preloading ghcr.io/fiaisis/mantidimaging on $NODE_NAME"
                kubectl run preload-mantidimaging-$NODE_NAME --image=ghcr.io/fiaisis/mantidimaging:latest --restart=Never --overrides='{"spec":{"nodeName":"'"$NODE_NAME"'"}}' --command -- true
              else
                echo "Node $NODE_NAME not matched; labelling as worker"
                kubectl label node "$NODE_NAME" node-type=worker
              fi

              sleep infinity
          securityContext:
            runAsUser: 0